// Add these NEW models to the END of schema.prisma file (after lead_score_history model)

/// Product variants - for products with multiple options (size, color, etc.)
model product_variants {
  variant_id    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id    String    @db.Uuid
  name          String    @db.VarChar(100)
  sku           String?   @db.VarChar(100)
  price         Decimal   @db.Decimal(10, 2)
  quantity      Int       @default(0)
  in_stock      Boolean   @default(true)
  variant_options Json?
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  updated_at    DateTime  @default(now()) @db.Timestamptz(6)
  product       products  @relation(fields: [product_id], references: [product_id], onDelete: Cascade)

  @@index([product_id], map: "idx_product_variants_product_id")
  @@index([sku], map: "idx_product_variants_sku")
}

/// Customers - separate from leads, represents actual customers
model customers {
  customer_id       String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id       String          @db.Uuid
  tenant_id         String          @db.Uuid
  name              String?         @db.VarChar(255)
  phone             String          @db.VarChar(20)
  email             String?         @db.VarChar(255)
  whatsapp_number   String?         @db.VarChar(20)
  total_orders      Int             @default(0)
  total_spent       Decimal         @default(0) @db.Decimal(10, 2)
  last_order_date   DateTime?       @db.Timestamptz(6)
  engagement_score  Int             @default(0)
  created_at        DateTime        @default(now()) @db.Timestamptz(6)
  updated_at        DateTime        @default(now()) @db.Timestamptz(6)
  business          businesses      @relation(fields: [business_id], references: [business_id], onDelete: Cascade)
  conversations     conversations[]
  messages          messages[]

  @@unique([business_id, phone], map: "unique_business_customer_phone")
  @@index([business_id], map: "idx_customers_business_id")
  @@index([phone], map: "idx_customers_phone")
  @@index([tenant_id], map: "idx_customers_tenant_id")
}

/// Conversations - unified conversation threads (WhatsApp, Web Chat, etc.)
model conversations {
  conversation_id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id              String     @db.Uuid
  customer_id              String     @db.Uuid
  channel                  String     @db.VarChar(20)
  channel_conversation_id  String?    @db.VarChar(255)
  status                   String     @default("active") @db.VarChar(20)
  assigned_to              String?    @db.Uuid
  escalation_level         Int        @default(0)
  started_at               DateTime   @default(now()) @db.Timestamptz(6)
  last_message_at          DateTime?  @db.Timestamptz(6)
  closed_at                DateTime?  @db.Timestamptz(6)
  business                 businesses @relation(fields: [business_id], references: [business_id], onDelete: Cascade)
  customer                 customers  @relation(fields: [customer_id], references: [customer_id], onDelete: Cascade)
  agent                    users?     @relation(fields: [assigned_to], references: [user_id])
  messages                 messages[]

  @@index([business_id, status], map: "idx_conversations_business_status")
  @@index([customer_id], map: "idx_conversations_customer_id")
  @@index([assigned_to], map: "idx_conversations_assigned_to")
  @@index([started_at(sort: Desc)], map: "idx_conversations_started_at")
}

/// Messages - individual messages in conversations
model messages {
  message_id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id   String         @db.Uuid
  customer_id       String         @db.Uuid
  sender_type       String         @db.VarChar(20)
  sender_id         String?        @db.Uuid
  message_type      String         @default("text") @db.VarChar(20)
  content           String?
  media_url         String?        @db.VarChar(255)
  media_type        String?        @db.VarChar(50)
  ai_processed      Boolean        @default(false)
  ai_intent         String?        @db.VarChar(100)
  ai_confidence     Decimal?       @db.Decimal(3, 2)
  ai_entities       Json?
  replied_by        String?        @db.VarChar(20)
  sent_at           DateTime       @default(now()) @db.Timestamptz(6)
  read_at           DateTime?      @db.Timestamptz(6)
  conversation      conversations  @relation(fields: [conversation_id], references: [conversation_id], onDelete: Cascade)
  customer          customers      @relation(fields: [customer_id], references: [customer_id])
  sender_user       users?         @relation(fields: [sender_id], references: [user_id])

  @@index([conversation_id, sent_at(sort: Desc)], map: "idx_messages_conversation_sent")
  @@index([customer_id], map: "idx_messages_customer_id")
  @@index([ai_intent], map: "idx_messages_ai_intent")
}

/// AI Training Data - FAQs and knowledge base for AI
model ai_training_data {
  training_id    String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id    String      @db.Uuid
  tenant_id      String      @db.Uuid
  type           String      @db.VarChar(50)
  question       String?
  answer         String?
  tags           Json?
  is_active      Boolean     @default(true)
  created_at     DateTime    @default(now()) @db.Timestamptz(6)
  updated_at     DateTime    @default(now()) @db.Timestamptz(6)
  business       businesses  @relation(fields: [business_id], references: [business_id], onDelete: Cascade)

  @@index([business_id, is_active], map: "idx_ai_training_data_business_active")
  @@index([type], map: "idx_ai_training_data_type")
  @@index([tenant_id], map: "idx_ai_training_data_tenant_id")
}

/// Business Onboarding Steps - track onboarding progress
model business_onboarding_steps {
  step_id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id    String      @db.Uuid
  step_name      String      @db.VarChar(100)
  is_completed   Boolean     @default(false)
  completed_at   DateTime?   @db.Timestamptz(6)
  created_at     DateTime    @default(now()) @db.Timestamptz(6)
  business       businesses  @relation(fields: [business_id], references: [business_id], onDelete: Cascade)

  @@unique([business_id, step_name], map: "unique_business_step")
  @@index([business_id], map: "idx_onboarding_steps_business_id")
  @@index([is_completed], map: "idx_onboarding_steps_is_completed")
}
